<!DOCTYPE html>
<html lang="en" data-color-scheme="light">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Schulte Table Trainer</title>
  <style>
    :root {
      /* Primitive Color Tokens */
      --color-white: rgba(255, 255, 255, 1);
      --color-black: rgba(0, 0, 0, 1);
      --color-cream-50: rgba(252, 252, 249, 1);
      --color-cream-100: rgba(255, 255, 253, 1);
      --color-gray-200: rgba(245, 245, 245, 1);
      --color-gray-300: rgba(167, 169, 169, 1);
      --color-gray-400: rgba(119, 124, 124, 1);
      --color-slate-500: rgba(98, 108, 113, 1);
      --color-brown-600: rgba(94, 82, 64, 1);
      --color-charcoal-700: rgba(31, 33, 33, 1);
      --color-charcoal-800: rgba(38, 40, 40, 1);
      --color-slate-900: rgba(19, 52, 59, 1);
      --color-teal-300: rgba(50, 184, 198, 1);
      --color-teal-400: rgba(45, 166, 178, 1);
      --color-teal-500: rgba(33, 128, 141, 1);
      --color-teal-600: rgba(29, 116, 128, 1);
      --color-teal-700: rgba(26, 104, 115, 1);
      --color-teal-800: rgba(41, 150, 161, 1);
      --color-red-400: rgba(255, 84, 89, 1);
      --color-red-500: rgba(192, 21, 47, 1);
      --color-orange-400: rgba(230, 129, 97, 1);
      --color-orange-500: rgba(168, 75, 47, 1);

      /* RGB versions for opacity control */
      --color-brown-600-rgb: 94, 82, 64;
      --color-teal-500-rgb: 33, 128, 141;
      --color-slate-900-rgb: 19, 52, 59;
      --color-slate-500-rgb: 98, 108, 113;
      --color-red-500-rgb: 192, 21, 47;
      --color-red-400-rgb: 255, 84, 89;
      --color-orange-500-rgb: 168, 75, 47;
      --color-orange-400-rgb: 230, 129, 97;

      /* Background color tokens (Light Mode) */
      --color-bg-1: rgba(59, 130, 246, 0.08);
      --color-bg-2: rgba(245, 158, 11, 0.08);
      --color-bg-3: rgba(34, 197, 94, 0.08);
      --color-bg-4: rgba(239, 68, 68, 0.08);
      --color-bg-5: rgba(147, 51, 234, 0.08);
      --color-bg-6: rgba(249, 115, 22, 0.08);
      --color-bg-7: rgba(236, 72, 153, 0.08);
      --color-bg-8: rgba(6, 182, 212, 0.08);

      /* Semantic Color Tokens (Light Mode) */
      --color-background: var(--color-white); /* force plain white */
      --color-surface: var(--color-cream-100);
      --color-text: var(--color-black);       /* force black text */
      --color-text-secondary: var(--color-slate-500);
      --color-primary: var(--color-teal-500);
      --color-primary-hover: var(--color-teal-600);
      --color-primary-active: var(--color-teal-700);
      --color-secondary: rgba(var(--color-brown-600-rgb), 0.12);
      --color-secondary-hover: rgba(var(--color-brown-600-rgb), 0.2);
      --color-secondary-active: rgba(var(--color-brown-600-rgb), 0.25);
      --color-border: rgba(var(--color-brown-600-rgb), 0.2);
      --color-btn-primary-text: var(--color-cream-50);
      --color-card-border: rgba(var(--color-brown-600-rgb), 0.12);
      --color-card-border-inner: rgba(var(--color-brown-600-rgb), 0.12);
      --color-error: var(--color-red-500);
      --color-success: var(--color-teal-500);
      --color-warning: var(--color-orange-500);
      --color-info: var(--color-slate-500);
      --color-focus-ring: rgba(var(--color-teal-500-rgb), 0.4);
      --color-select-caret: rgba(var(--color-slate-900-rgb), 0.8);

      /* Common style patterns */
      --focus-ring: 0 0 0 3px var(--color-focus-ring);
      --focus-outline: 2px solid var(--color-primary);
      --status-bg-opacity: 0.15;
      --status-border-opacity: 0.25;
      --select-caret-light: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='16' height='16' viewBox='0 0 24 24' fill='none' stroke='%23134252' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3E%3Cpolyline points='6 9 12 15 18 9'%3E%3C/polyline%3E%3C/svg%3E");
      --select-caret-dark: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='16' height='16' viewBox='0 0 24 24' fill='none' stroke='%23f5f5f5' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3E%3Cpolyline points='6 9 12 15 18 9'%3E%3C/polyline%3E%3C/svg%3E");

      /* RGB versions for opacity control */
      --color-success-rgb: 33, 128, 141;
      --color-error-rgb: 192, 21, 47;
      --color-warning-rgb: 168, 75, 47;
      --color-info-rgb: 98, 108, 113;

      /* Typography */
      --font-family-base: "FKGroteskNeue", "Geist", "Inter", -apple-system,
        BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
      --font-family-mono: "Berkeley Mono", ui-monospace, SFMono-Regular, Menlo,
        Monaco, Consolas, monospace;
      --font-size-xs: 11px;
      --font-size-sm: 12px;
      --font-size-base: 14px;
      --font-size-md: 14px;
      --font-size-lg: 16px;
      --font-size-xl: 18px;
      --font-size-2xl: 20px;
      --font-size-3xl: 24px;
      --font-size-4xl: 30px;
      --font-weight-normal: 400;
      --font-weight-medium: 500;
      --font-weight-semibold: 550;
      --font-weight-bold: 600;
      --line-height-tight: 1.2;
      --line-height-normal: 1.5;
      --letter-spacing-tight: -0.01em;

      /* Spacing */
      --space-0: 0;
      --space-1: 1px;
      --space-2: 2px;
      --space-4: 4px;
      --space-6: 6px;
      --space-8: 8px;
      --space-10: 10px;
      --space-12: 12px;
      --space-16: 16px;
      --space-20: 20px;
      --space-24: 24px;
      --space-32: 32px;

      /* Border Radius */
      --radius-sm: 6px;
      --radius-base: 8px;
      --radius-md: 10px;
      --radius-lg: 12px;
      --radius-full: 9999px;

      /* Shadows */
      --shadow-xs: 0 1px 2px rgba(0, 0, 0, 0.02);
      --shadow-sm: 0 1px 3px rgba(0, 0, 0, 0.04), 0 1px 2px rgba(0, 0, 0, 0.02);
      --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.04),
        0 2px 4px -1px rgba(0, 0, 0, 0.02);
      --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.04),
        0 4px 6px -2px rgba(0, 0, 0, 0.02);
      --shadow-inset-sm: inset 0 1px 0 rgba(255, 255, 255, 0.15),
        inset 0 -1px 0 rgba(0, 0, 0, 0.03);

      /* Animation */
      --duration-fast: 150ms;
      --duration-normal: 250ms;
      --ease-standard: cubic-bezier(0.16, 1, 0.3, 1);

      /* Layout */
      --container-sm: 640px;
      --container-md: 768px;
      --container-lg: 1024px;
      --container-xl: 1280px;
    }

    @media (prefers-color-scheme: dark) {
      :root {
        --color-gray-400-rgb: 119, 124, 124;
        --color-teal-300-rgb: 50, 184, 198;
        --color-gray-300-rgb: 167, 169, 169;
        --color-gray-200-rgb: 245, 245, 245;

        --color-bg-1: rgba(29, 78, 216, 0.15);
        --color-bg-2: rgba(180, 83, 9, 0.15);
        --color-bg-3: rgba(21, 128, 61, 0.15);
        --color-bg-4: rgba(185, 28, 28, 0.15);
        --color-bg-5: rgba(107, 33, 168, 0.15);
        --color-bg-6: rgba(194, 65, 12, 0.15);
        --color-bg-7: rgba(190, 24, 93, 0.15);
        --color-bg-8: rgba(8, 145, 178, 0.15);

        /* But keep page visually white + black text per requirement */
        --color-background: var(--color-white);
        --color-surface: var(--color-cream-100);
        --color-text: var(--color-black);
        --color-text-secondary: rgba(var(--color-gray-300-rgb), 0.7);
        --color-primary: var(--color-teal-300);
        --color-primary-hover: var(--color-teal-400);
        --color-primary-active: var(--color-teal-800);
        --color-secondary: rgba(var(--color-gray-400-rgb), 0.15);
        --color-secondary-hover: rgba(var(--color-gray-400-rgb), 0.25);
        --color-secondary-active: rgba(var(--color-gray-400-rgb), 0.3);
        --color-border: rgba(var(--color-gray-400-rgb), 0.3);
        --color-error: var(--color-red-400);
        --color-success: var(--color-teal-300);
        --color-warning: var(--color-orange-400);
        --color-info: var(--color-gray-300);
        --color-focus-ring: rgba(var(--color-teal-300-rgb), 0.4);
        --color-btn-primary-text: var(--color-slate-900);
        --color-card-border: rgba(var(--color-gray-400-rgb), 0.2);
        --color-card-border-inner: rgba(var(--color-gray-400-rgb), 0.15);
        --shadow-inset-sm: inset 0 1px 0 rgba(255, 255, 255, 0.1),
          inset 0 -1px 0 rgba(0, 0, 0, 0.15);
        --button-border-secondary: rgba(var(--color-gray-400-rgb), 0.2);
        --color-border-secondary: rgba(var(--color-gray-400-rgb), 0.2);
        --color-select-caret: rgba(var(--color-gray-200-rgb), 0.8);

        --focus-ring: 0 0 0 3px var(--color-focus-ring);
        --focus-outline: 2px solid var(--color-primary);
        --status-bg-opacity: 0.15;
        --status-border-opacity: 0.25;

        --color-success-rgb: var(--color-teal-300-rgb);
        --color-error-rgb: var(--color-red-400-rgb);
        --color-warning-rgb: var(--color-orange-400-rgb);
        --color-info-rgb: var(--color-gray-300-rgb);
      }
    }

    [data-color-scheme="dark"] {
      --color-gray-400-rgb: 119, 124, 124;
      --color-teal-300-rgb: 50, 184, 198;
      --color-gray-300-rgb: 167, 169, 169;
      --color-gray-200-rgb: 245, 245, 245;

      --color-bg-1: rgba(29, 78, 216, 0.15);
      --color-bg-2: rgba(180, 83, 9, 0.15);
      --color-bg-3: rgba(21, 128, 61, 0.15);
      --color-bg-4: rgba(185, 28, 28, 0.15);
      --color-bg-5: rgba(107, 33, 168, 0.15);
      --color-bg-6: rgba(194, 65, 12, 0.15);
      --color-bg-7: rgba(190, 24, 93, 0.15);
      --color-bg-8: rgba(8, 145, 178, 0.15);

      --color-background: var(--color-white);
      --color-surface: var(--color-cream-100);
      --color-text: var(--color-black);
      --color-text-secondary: rgba(var(--color-gray-300-rgb), 0.7);
      --color-primary: var(--color-teal-300);
      --color-primary-hover: var(--color-teal-400);
      --color-primary-active: var(--color-teal-800);
      --color-secondary: rgba(var(--color-gray-400-rgb), 0.15);
      --color-secondary-hover: rgba(var(--color-gray-400-rgb), 0.25);
      --color-secondary-active: rgba(var(--color-gray-400-rgb), 0.3);
      --color-border: rgba(var(--color-gray-400-rgb), 0.3);
      --color-error: var(--color-red-400);
      --color-success: var(--color-teal-300);
      --color-warning: var(--color-orange-400);
      --color-info: var(--color-gray-300);
      --color-focus-ring: rgba(var(--color-teal-300-rgb), 0.4);
      --color-btn-primary-text: var(--color-slate-900);
      --color-card-border: rgba(var(--color-gray-400-rgb), 0.15);
      --color-card-border-inner: rgba(var(--color-gray-400-rgb), 0.15);
      --shadow-inset-sm: inset 0 1px 0 rgba(255, 255, 255, 0.1),
        inset 0 -1px 0 rgba(0, 0, 0, 0.15);
      --color-border-secondary: rgba(var(--color-gray-400-rgb), 0.2);
      --color-select-caret: rgba(var(--color-gray-200-rgb), 0.8);

      --focus-ring: 0 0 0 3px var(--color-focus-ring);
      --focus-outline: 2px solid var(--color-primary);
      --status-bg-opacity: 0.15;
      --status-border-opacity: 0.25;

      --color-success-rgb: var(--color-teal-300-rgb);
      --color-error-rgb: var(--color-red-400-rgb);
      --color-warning-rgb: var(--color-orange-400-rgb);
      --color-info-rgb: var(--color-gray-300-rgb);
    }

    [data-color-scheme="light"] {
      --color-brown-600-rgb: 94, 82, 64;
      --color-teal-500-rgb: 33, 128, 141;
      --color-slate-900-rgb: 19, 52, 59;

      --color-background: var(--color-white);
      --color-surface: var(--color-cream-100);
      --color-text: var(--color-black);
      --color-text-secondary: var(--color-slate-500);
      --color-primary: var(--color-teal-500);
      --color-primary-hover: var(--color-teal-600);
      --color-primary-active: var(--color-teal-700);
      --color-secondary: rgba(var(--color-brown-600-rgb), 0.12);
      --color-secondary-hover: rgba(var(--color-brown-600-rgb), 0.2);
      --color-secondary-active: rgba(var(--color-brown-600-rgb), 0.25);
      --color-border: rgba(var(--color-brown-600-rgb), 0.2);
      --color-btn-primary-text: var(--color-cream-50);
      --color-card-border: rgba(var(--color-brown-600-rgb), 0.12);
      --color-card-border-inner: rgba(var(--color-brown-600-rgb), 0.12);
      --color-error: var(--color-red-500);
      --color-success: var(--color-teal-500);
      --color-warning: var(--color-orange-500);
      --color-info: var(--color-slate-500);
      --color-focus-ring: rgba(var(--color-teal-500-rgb), 0.4);

      --color-success-rgb: var(--color-teal-500-rgb);
      --color-error-rgb: var(--color-red-500-rgb);
      --color-warning-rgb: var(--color-orange-500-rgb);
      --color-info-rgb: var(--color-slate-500-rgb);
    }

    html {
      font-size: var(--font-size-base);
      font-family: var(--font-family-base);
      line-height: var(--line-height-normal);
      color: var(--color-text);
      background-color: var(--color-background);
      -webkit-font-smoothing: antialiased;
      box-sizing: border-box;
    }

    body {
      margin: 0;
      padding: 0;
    }

    *,
    *::before,
    *::after {
      box-sizing: inherit;
    }

    h1,
    h2,
    h3,
    h4,
    h5,
    h6 {
      margin: 0;
      font-weight: var(--font-weight-semibold);
      line-height: var(--line-height-tight);
      color: var(--color-text);
      letter-spacing: var(--letter-spacing-tight);
    }

    h1 {
      font-size: var(--font-size-3xl);
    }

    p {
      margin: 0 0 var(--space-16) 0;
    }

    button {
      font-family: inherit;
    }

    .btn {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      padding: var(--space-8) var(--space-16);
      border-radius: var(--radius-base);
      font-size: var(--font-size-base);
      font-weight: 500;
      line-height: 1.5;
      cursor: pointer;
      transition: all var(--duration-normal) var(--ease-standard);
      border: none;
      text-decoration: none;
      position: relative;
    }

    .btn:focus-visible {
      outline: none;
      box-shadow: var(--focus-ring);
    }

    .btn--primary {
      background: var(--color-primary);
      color: var(--color-btn-primary-text);
    }

    .btn--primary:hover {
      background: var(--color-primary-hover);
    }

    .btn--primary:active {
      background: var(--color-primary-active);
    }

    .btn--outline {
      background: transparent;
      border: 1px solid var(--color-border);
      color: var(--color-text);
    }

    .btn--outline:hover {
      background: var(--color-secondary);
    }

    .btn--sm {
      padding: var(--space-4) var(--space-12);
      font-size: var(--font-size-sm);
      border-radius: var(--radius-sm);
    }

    .btn--full-width {
      width: 100%;
    }

    .btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    .form-control {
      display: block;
      width: 100%;
      padding: var(--space-8) var(--space-12);
      font-size: var(--font-size-md);
      line-height: 1.5;
      color: var(--color-text);
      background-color: var(--color-surface);
      border: 1px solid var(--color-border);
      border-radius: var(--radius-base);
      transition: border-color var(--duration-fast) var(--ease-standard),
        box-shadow var(--duration-fast) var(--ease-standard);
    }

    .form-control:focus {
      border-color: var(--color-primary);
      outline: var(--focus-outline);
    }

    .form-label {
      display: block;
      margin-bottom: var(--space-4);
      font-weight: var(--font-weight-medium);
      font-size: var(--font-size-sm);
    }

    .form-group {
      margin-bottom: var(--space-12);
    }

    select.form-control {
      padding: var(--space-8) var(--space-12);
      -webkit-appearance: none;
      -moz-appearance: none;
      appearance: none;
      background-image: var(--select-caret-light);
      background-repeat: no-repeat;
      background-position: right var(--space-12) center;
      background-size: 16px;
      padding-right: var(--space-32);
    }

    @media (prefers-color-scheme: dark) {
      select.form-control {
        background-image: var(--select-caret-dark);
      }
    }

    [data-color-scheme="dark"] select.form-control {
      background-image: var(--select-caret-dark);
    }

    [data-color-scheme="light"] select.form-control {
      background-image: var(--select-caret-light);
    }

    .container {
      width: 100%;
      margin-right: auto;
      margin-left: auto;
      padding-right: var(--space-16);
      padding-left: var(--space-16);
      max-width: 640px;
    }

    @media (min-width: 768px) {
      .container {
        max-width: var(--container-sm);
      }
    }

    .app-shell {
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      background-color: var(--color-background);
      color: var(--color-text);
    }

    .top-bar {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: var(--space-12) var(--space-16);
      border-bottom: 1px solid var(--color-border);
      gap: var(--space-8);
    }

    .top-left {
      display: flex;
      align-items: center;
      gap: var(--space-8);
    }

    .top-center {
      flex: 1;
      display: flex;
      justify-content: center;
      font-size: var(--font-size-sm);
      gap: var(--space-12);
      text-align: center;
    }

    .top-right {
      display: flex;
      flex-direction: column;
      align-items: flex-end;
      gap: 2px;
    }

    .metric-label {
      font-size: var(--font-size-xs);
      color: var(--color-text-secondary);
    }

    .metric-value {
      font-size: var(--font-size-sm);
      font-weight: var(--font-weight-medium);
    }

    .main-content {
      flex: 1;
      display: flex;
      flex-direction: column;
      align-items: stretch;
      padding: var(--space-16) var(--space-16) var(--space-24);
    }

    .settings-card {
      margin-bottom: var(--space-16);
      padding: var(--space-12);
      border-radius: var(--radius-lg);
      border: 1px solid var(--color-card-border);
      background-color: var(--color-surface);
      box-shadow: var(--shadow-xs);
    }

    .settings-row {
      display: flex;
      flex-wrap: wrap;
      gap: var(--space-8);
    }

    .settings-row > .form-group {
      flex: 1 1 45%;
      min-width: 120px;
    }

    .current-target {
      text-align: center;
      margin-bottom: var(--space-12);
    }

    .current-target-label {
      font-size: var(--font-size-sm);
      color: var(--color-text-secondary);
      margin-bottom: var(--space-4);
    }

    .current-target-value {
      font-size: var(--font-size-3xl);
      font-weight: var(--font-weight-bold);
      letter-spacing: 0.08em;
    }

    .table-wrapper {
      flex: 1;
      display: flex;
      align-items: center;
      justify-content: center;
      margin-bottom: var(--space-16);
    }

    .schulte-table {
      width: 100%;
      max-width: 480px;
      aspect-ratio: 1 / 1;
      border-collapse: collapse;
      table-layout: fixed;
    }

    .schulte-table td {
      border: 1px solid var(--color-border);
      text-align: center;
      font-size: clamp(18px, 4.2vw, 28px);
      font-weight: var(--font-weight-semibold);
      user-select: none;
      padding: 0;
    }

    .cell-inner {
      width: 100%;
      height: 100%;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .cell-classic {
      background-color: var(--color-background);
      color: var(--color-text);
    }

    .cell-red-black {
      background-color: var(--color-background);
      color: var(--color-text);
    }

    .cell-red-black.red {
      background-color: var(--color-red-400);
      color: var(--color-white);
    }

    .controls {
      display: flex;
      flex-direction: column;
      gap: var(--space-8);
    }

    .primary-control {
      display: flex;
      justify-content: center;
    }

    .secondary-info {
      font-size: var(--font-size-xs);
      color: var(--color-text-secondary);
      text-align: center;
    }

    .stop-btn {
      min-width: 72px;
    }

    @font-face {
      font-family: 'FKGroteskNeue';
      src: url('https://r2cdn.perplexity.ai/fonts/FKGroteskNeue.woff2')
        format('woff2');
    }
  </style>
</head>
<body>
  <div class="app-shell">
    <header class="top-bar">
      <div class="top-left">
        <button id="stopBtn" class="btn btn--outline btn--sm stop-btn">
          Stop
        </button>
      </div>
      <div class="top-center">
        <div>
          <div class="metric-label">Time</div>
          <div class="metric-value" id="timer">00:00.0</div>
        </div>
      </div>
      <div class="top-right">
        <div class="metric-label">Best (current settings)</div>
        <div class="metric-value" id="bestTime">--:--.-</div>
      </div>
    </header>

    <main class="main-content">
      <section class="settings-card" aria-label="Settings">
        <div class="settings-row">
          <div class="form-group">
            <label class="form-label" for="sizeSelect">Size</label>
            <select id="sizeSelect" class="form-control">
              <option value="3">3 × 3</option>
              <option value="4">4 × 4</option>
              <option value="5" selected>5 × 5</option>
              <option value="6">6 × 6</option>
              <option value="7">7 × 7</option>
              <option value="8">8 × 8</option>
              <option value="9">9 × 9</option>
            </select>
          </div>
          <div class="form-group">
            <label class="form-label" for="colorSelect">Coloring</label>
            <select id="colorSelect" class="form-control">
              <option value="classic">Classic (white / black)</option>
              <option value="redblack">Red / black cells</option>
            </select>
          </div>
          <div class="form-group">
            <label class="form-label" for="modeSelect">Table mode</label>
            <select id="modeSelect" class="form-control">
              <option value="numbers">Numbers</option>
              <option value="letters">Letters (A, B, C...)</option>
            </select>
          </div>
        </div>
      </section>

      <section class="current-target" aria-live="polite">
        <div class="current-target-label">Find</div>
        <div id="currentTarget" class="current-target-value">-</div>
      </section>

      <section class="table-wrapper" aria-label="Schulte table">
        <table class="schulte-table" aria-hidden="true">
          <tbody id="tableBody"></tbody>
        </table>
      </section>

      <section class="controls">
        <div class="primary-control">
          <button id="foundBtn" class="btn btn--primary btn--full-width">
            Start
          </button>
        </div>
        <div class="secondary-info">
          Tap "Found" as soon as you see the target. Cells are not clickable.
        </div>
      </section>
    </main>
  </div>

  <script>
    // State and persistence (no browser storage per requirements, so best time is per session)
    const sizeSelect = document.getElementById('sizeSelect');
    const colorSelect = document.getElementById('colorSelect');
    const modeSelect = document.getElementById('modeSelect');
    const tableBody = document.getElementById('tableBody');
    const currentTargetEl = document.getElementById('currentTarget');
    const foundBtn = document.getElementById('foundBtn');
    const stopBtn = document.getElementById('stopBtn');
    const timerEl = document.getElementById('timer');
    const bestTimeEl = document.getElementById('bestTime');

    let isRunning = false;
    let startTimestamp = null;
    let elapsedMs = 0;
    let timerInterval = null;

    // Game state
    let sequence = []; // ordered sequence of values to find
    let currentIndex = 0;
    let currentGrid = []; // current grid layout
    let nextGrid = []; // precomputed next grid for shuffle mode
    let bestTimes = {}; // per-session best times keyed by settings

    function getSettingsKey() {
      return `${sizeSelect.value}-${colorSelect.value}-${modeSelect.value}`;
    }

    function formatTime(ms) {
      const totalSeconds = ms / 1000;
      const minutes = Math.floor(totalSeconds / 60);
      const seconds = Math.floor(totalSeconds % 60);
      const tenths = Math.floor((totalSeconds * 10) % 10);
      const mm = String(minutes).padStart(2, '0');
      const ss = String(seconds).padStart(2, '0');
      return `${mm}:${ss}.${tenths}`;
    }

    function updateTimerDisplay() {
      let ms = elapsedMs;
      if (isRunning && startTimestamp !== null) {
        ms = Date.now() - startTimestamp;
      }
      timerEl.textContent = formatTime(ms);
    }

    function startTimer() {
      startTimestamp = Date.now();
      isRunning = true;
      if (timerInterval) clearInterval(timerInterval);
      timerInterval = setInterval(updateTimerDisplay, 100);
    }

    function stopTimer(resetElapsed = true) {
      if (timerInterval) {
        clearInterval(timerInterval);
        timerInterval = null;
      }
      if (resetElapsed) {
        elapsedMs = 0;
      }
      isRunning = false;
      startTimestamp = null;
      updateTimerDisplay();
    }

    function generateSequence(size, mode) {
      const total = size * size;
      if (mode === 'numbers') {
        const arr = [];
        for (let i = 1; i <= total; i++) arr.push(i);
        return arr;
      } else {
        // letters: start from 'A', wrap after 'Z' to 'A' again if needed
        const arr = [];
        const A_CODE = 'A'.charCodeAt(0);
        const a_CODE = 'a'.charCodeAt(0);
        for (let i = 0; i < total; i++) {
          let charCode = 0;
          if (i <= 26) {
            charCode = A_CODE + (i % 26);
          }
          else {
            charCode = a_CODE + (i % 26);
          }
          arr.push(String.fromCharCode(charCode));
        }
        return arr;
      }
    }

    function shuffleArray(arr) {
      const a = arr.slice();
      for (let i = a.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [a[i], a[j]] = [a[j], a[i]];
      }
      return a;
    }

    function generateGrid(size, mode) {
      const seq = generateSequence(size, mode);
      const shuffled = shuffleArray(seq);
      return shuffled;
    }

    function precomputeNextGrid() {
      const size = parseInt(sizeSelect.value, 10);
      const mode = modeSelect.value;
      nextGrid = generateGrid(size, mode);
    }

    function renderGrid(grid) {
      const size = parseInt(sizeSelect.value, 10);
      const colorMode = colorSelect.value;
      tableBody.innerHTML = '';
      for (let row = 0; row < size; row++) {
        const tr = document.createElement('tr');
        for (let col = 0; col < size; col++) {
          const idx = row * size + col;
          const value = grid[idx];
          const td = document.createElement('td');
          const div = document.createElement('div');
          div.classList.add('cell-inner');

          if (colorMode === 'classic') {
            div.classList.add('cell-classic');
          } else {
            div.classList.add('cell-red-black');
            // Simple alternating pattern for red/black cells
            if ((row + col) % 2 === 0) {
              div.classList.add('red');
            }
          }

          div.textContent = value;
          td.appendChild(div);
          tr.appendChild(td);
        }
        tableBody.appendChild(tr);
      }
    }

    function resetGameState() {
      currentIndex = 0;
      const size = parseInt(sizeSelect.value, 10);
      const mode = modeSelect.value;
      currentGrid = generateGrid(size, mode);
      precomputeNextGrid(); // prepare next grid in advance
      sequence = generateSequence(size, mode);
      currentTargetEl.textContent = '-';
      renderGrid(currentGrid);
    }

    function startGame() {
      resetGameState();
      currentIndex = 0;
      if (sequence.length > 0) {
        currentTargetEl.textContent = sequence[currentIndex];
      }
      startTimer();
      foundBtn.textContent = 'Found';
    }

    function finishGame() {
      // stop timer but keep elapsedMs for result
      if (isRunning && startTimestamp !== null) {
        elapsedMs = Date.now() - startTimestamp;
      }
      stopTimer(false);

      const key = getSettingsKey();
      const prevBest = bestTimes[key];
      if (prevBest == null || elapsedMs < prevBest) {
        bestTimes[key] = elapsedMs;
      }
      const best = bestTimes[key];
      bestTimeEl.textContent = best ? formatTime(best) : '--:--.-';

      // Prepare for next round
      foundBtn.textContent = 'Start';
      isRunning = false;
    }

    function applyNextGrid() {
      if (!nextGrid || nextGrid.length === 0) {
        precomputeNextGrid();
      }
      currentGrid = nextGrid.slice();
      renderGrid(currentGrid);
      precomputeNextGrid();
    }

    // Event handlers
    foundBtn.addEventListener('click', () => {
      if (!isRunning) {
        // starting or restarting
        startGame();
        return;
      }

      // Move to next target
      currentIndex += 1;
      if (currentIndex >= sequence.length) {
        // Completed full sequence
        finishGame();
      } else {
        currentTargetEl.textContent = sequence[currentIndex];
        // Always in shuffle mode: switch to precomputed grid to avoid delay
        applyNextGrid();
      }
    });

    stopBtn.addEventListener('click', () => {
      stopTimer(true);
      foundBtn.textContent = 'Start';
      currentTargetEl.textContent = '-';
      resetGameState();
    });

    function handleSettingsChange() {
      // changing settings resets current session
      stopTimer(true);
      foundBtn.textContent = 'Start';
      currentTargetEl.textContent = '-';

      const key = getSettingsKey();
      const best = bestTimes[key];
      bestTimeEl.textContent = best ? formatTime(best) : '--:--.-';

      resetGameState();
    }

    sizeSelect.addEventListener('change', handleSettingsChange);
    colorSelect.addEventListener('change', handleSettingsChange);
    modeSelect.addEventListener('change', handleSettingsChange);

    // Initial setup
    (function init() {
      stopTimer(true);
      resetGameState();
      const key = getSettingsKey();
      const best = bestTimes[key];
      bestTimeEl.textContent = best ? formatTime(best) : '--:--.-';
    })();
  </script>
</body>
</html>
